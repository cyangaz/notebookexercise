---
title: "RNA-Seq data analysis"
output: html_notebook
---

Introduction
============

We're going to compare the expression levels of all genes in two conditionsl, Ish and T47D.  We have 5 replicates for each condition.


Setup
=====

```{r message=FALSE}
library(tidyverse)
```


Prepare the data
================

Read the TSV
------------

```{r "Read Data TSV", message=FALSE}
read_tsv(
  "rnaseq_counts.txt",
  guess_max=1000000
) -> data

head(data)
```
Restructuring
-------------

We're going to split apart the annotation and the data to save space.

```{r}
data %>%
  select(Probe:Distance) -> data.annotation
```

We can then remove the annotation from the data and restructure it.


```{r}
data %>%
  select(-(Chromosome:Distance)) %>%
  pivot_longer(
    cols=-Probe,
    names_to="sample",
    values_to="count"
  ) %>%
  separate(
    sample,
    into=c("condition","replicate"),
    sep="_",
    remove = FALSE
  ) -> data

head(data)
```
Let's remove any genes which are unmeasured in all samples.

```{r}
data %>%
  group_by(Probe) %>%
  summarise(
    max = max(count)
  ) %>%
  ungroup() %>%
  filter(max==0) %>%
  pull(Probe) -> unmeasured.probes


data %>%
  filter(! Probe %in% unmeasured.probes ) -> data
```

Normalisation
-------------

We want to express our data as log2RPM (reads per million reads of library)

```{r}
data %>%
  group_by(sample) %>%
  mutate(
    log2RPM = log2( (count+1) / (sum(count)/1000000) )
  ) %>%
  ungroup()-> data

head(data)
```

Normalisation check
-------------------

Let's check the distributions of all of the samples with a violin plot.

```{r}
data %>%
  ggplot(aes(x=sample, y=log2RPM, fill=condition)) +
  geom_violin() +
  scale_fill_brewer(palette = "Set1")

```

Average per gene
----------------

We want to know the mean expression per gene for each of the conditions.

```{r}
data %>%
  group_by(Probe, condition) %>%
  summarise(
    expression=mean(log2RPM)
  ) %>%
  ungroup() %>%
  pivot_wider(
    names_from=condition,
    values_from=expression
  ) -> data.per.sample

head(data.per.sample)
```


Plotting and Analysis
=====================













